<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('partials/_head.ejs') %>
    <title>Edit Feedback Form</title>
    <script src="/js/editForm.js"></script> <!-- Include the JavaScript file for handling dynamic question addition and removal -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.6/Sortable.min.js"></script>
    <script src="/js/historyManager.js"></script>
    <script src="/js/idGenerator.js"></script>
    <script src="/js/predicateEvaluator.js"></script>
    <script src="/js/placeholderResolver.js"></script>
    <script src="/js/snapshotManager.js"></script>
    <script src="/js/snapshotComparer.js"></script>
    <script src="/js/autosaveManager.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tributejs/5.1.3/tribute.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tributejs/5.1.3/tribute.min.js"></script>
</head>
<body>
    <%- include('partials/_header.ejs') %>
    <div class="container-fluid mt-5">
        <div class="row">
            <div class="col-md-5">
                <h1>Edit Feedback Form</h1>
                <form action="/update-form/<%= form._id %>" method="POST" id="editForm">
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                    <div class="mb-3">
                <label for="title" class="form-label">Form Title</label>
                <input type="text" class="form-control" id="title" name="title" value="<%= form.title %>" required>
            </div>
            <style>
                .block {
                    border: 1px solid #ccc;
                    padding: 10px;
                    margin-bottom: 10px;
                    background-color: #f9f9f9;
                }
                .drag-handle {
                    cursor: move;
                    display: inline-block;
                    width: 20px;
                    height: 20px;
                    background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M2 11h16v2H2zM2 7h16v2H2zM2 3h16v2H2zM2 15h16v2H2z"/></svg>');
                    background-repeat: no-repeat;
                    background-position: center;
                }
                .sortable-placeholder {
                    border: 2px dashed #ccc;
                    background-color: #f0f0f0;
                    height: 50px;
                }
            </style>
            <div id="questionsContainer">
            </div>
            <div id="inspector" style="display: none; border: 1px solid #ccc; padding: 10px; margin-top: 10px;">
                <h4>Inspector</h4>
                <ul class="nav nav-tabs" id="inspectorTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button" role="tab" aria-controls="general" aria-selected="true">General</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="logic-tab" data-bs-toggle="tab" data-bs-target="#logic" type="button" role="tab" aria-controls="logic" aria-selected="false">Logic</button>
                    </li>
                </ul>
                <div class="tab-content" id="inspectorTabContent">
                    <div class="tab-pane fade show active" id="general" role="tabpanel" aria-labelledby="general-tab">
                        <div id="general-tab-content"></div>
                    </div>
                    <div class="tab-pane fade" id="logic" role="tabpanel" aria-labelledby="logic-tab">
                        <div id="logic-tab-content"></div>
                    </div>
                </div>
            </div>
            <button type="button" class="btn btn-secondary mb-3" onclick="window.formEditor.addShortTextQuestionBlock()">Add Short Text</button>
            <button type="button" class="btn btn-secondary mb-3" onclick="window.formEditor.addSingleChoiceQuestionBlock()">Add Single Choice</button>
            <button type="button" class="btn btn-secondary mb-3" onclick="window.formEditor.addMultipleChoiceQuestionBlock()">Add Multiple Choice</button>
            <button type="button" class="btn btn-secondary mb-3" onclick="window.formEditor.addNumberQuestionBlock()">Add Number</button>
            <button type="button" class="btn btn-secondary mb-3" onclick="window.formEditor.addEmailQuestionBlock()">Add Email</button>
            <button type="button" class="btn btn-secondary mb-3" onclick="window.formEditor.addDateQuestionBlock()">Add Date</button>
            <button type="button" class="btn btn-secondary mb-3" onclick="window.formEditor.addMatrixSingleQuestionBlock()">Add Matrix (Single-select)</button>
            <button type="button" class="btn btn-secondary mb-3" onclick="window.formEditor.addMatrixMultiQuestionBlock()">Add Matrix (Multi-select)</button>
            <button type="button" class="btn btn-secondary mb-3" onclick="window.formEditor.addRankingQuestionBlock()">Add Ranking</button>
            <button type="button" class="btn btn-secondary mb-3" onclick="window.formEditor.addFileUploadQuestionBlock()">Add File Upload</button>
            <button type="button" class="btn btn-secondary mb-3" onclick="window.formEditor.addConsentCheckboxBlock()">Add Consent Checkbox</button>
            <button type="button" id="addTextBlockBtn" class="btn btn-secondary mb-3" onclick="window.formEditor.addTextBlock()">Add Text Block</button>
            <button type="button" id="addDividerBtn" class="btn btn-secondary mb-3" onclick="window.formEditor.addDividerBlock()">Add Divider</button>
            <button type="button" id="validateBtn" class="btn btn-info mb-3">Validate</button>
            <button type="button" id="publishBtn" class="btn btn-success mb-3">Publish</button>
            <div class="btn-group mb-3">
                <button type="button" class="btn btn-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                    Versions
                </button>
                <ul class="dropdown-menu" id="versions-dropdown">
                    <li><a class="dropdown-item" href="#" id="save-version-btn">Save current version...</a></li>
                    <li><hr class="dropdown-divider"></li>
                </ul>
            </div>
            <button type="button" id="translateBtn" class="btn btn-warning mb-3">Translate</button>
            <button type="submit" class="btn btn-primary" style="background-color: #007bff;">Update Form</button>
        </form>
        <div id="errorContainer" class="alert alert-danger mt-3" style="display: none;">
            <h5>Validation Errors:</h5>
            <ul id="errorList"></ul>
        </div>
        <div id="warningContainer" class="alert alert-warning mt-3" style="display: none;">
            <h5>Validation Warnings:</h5>
            <ul id="warningList"></ul>
        </div>
    </div>
    <div class="col-md-3">
        <h4>Theme Editor</h4>
        <div id="theme-editor-panel" style="border: 1px solid #ccc; padding: 10px; min-height: 250px;">
            <div class="mb-3">
                <label for="theme-primary-color" class="form-label">Primary Color</label>
                <input type="color" id="theme-primary-color" class="form-control" value="#007bff">
            </div>
            <div class="mb-3">
                <label for="theme-border-radius" class="form-label">Border Radius (px)</label>
                <input type="number" id="theme-border-radius" class="form-control" value="4">
            </div>
            <div class="mb-3">
                <label for="theme-font-family" class="form-label">Font Family</label>
                <input type="text" id="theme-font-family" class="form-control" value="sans-serif">
            </div>
        </div>
        <h4>Mock Answers</h4>
        <div id="mock-answers-panel" style="border: 1px solid #ccc; padding: 10px; min-height: 250px;"></div>
    </div>
    <div class="col-md-4">
        <h4>Preview</h4>
        <div id="preview-pane" style="border: 1px solid #ccc; padding: 10px; min-height: 500px;"></div>
    </div>
        </div>
    </div>
    <%- include('partials/_footer.ejs') %>
    <%- include('partials/_ruleTemplate.ejs') %>

    <!-- Publish Modal -->
    <div class="modal fade" id="publishModal" tabindex="-1" aria-labelledby="publishModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="publishModalLabel">Publish Survey</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>This is the JSON snapshot of your survey. You can download it for your records.</p>
                    <pre id="jsonSnapshot" style="background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 1rem; border-radius: 0.25rem;"></pre>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" id="downloadJsonBtn" class="btn btn-primary">Download JSON</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Compare Modal -->
    <div class="modal fade" id="compareModal" tabindex="-1" aria-labelledby="compareModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="compareModalLabel">Compare Snapshots</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Compare <strong><span id="compare-snapshot-name"></span></strong> with:</p>
                    <select id="compare-with-select" class="form-select"></select>
                    <div id="compare-results" class="mt-3"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Translation Modal -->
    <div class="modal fade" id="translationModal" tabindex="-1" aria-labelledby="translationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="translationModalLabel">Translate Form</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Key</th>
                                <th>English</th>
                                <th>Spanish</th>
                            </tr>
                        </thead>
                        <tbody id="translation-table-body">
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" id="exportCsvBtn" class="btn btn-primary">Export CSV</button>
                </div>
            </div>
        </div>
    </div>

    <div id="command-palette" class="modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <input type="text" id="command-palette-input" class="form-control" placeholder="Type a command...">
                </div>
                <div class="modal-body">
                    <ul id="command-palette-results" class="list-group">
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/formEditor.js"></script>
    <script src="/js/commandPalette.js"></script>
</body>
</html>