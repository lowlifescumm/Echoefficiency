<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('partials/_head.ejs') %>
    <title>Dashboard</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/bokehButtonStyles.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"></script>
</head>
<body>
    <%- include('partials/_header.ejs') %>
    <div class="container mt-5">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <h1>Welcome to Your Dashboard</h1>
        <p>Here you can manage your feedback forms.</p>
        <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#createFormModal">
            Create New Form
        </button>
        <% if (forms.length > 0) { %>
            <div class="list-group">
                <% forms.forEach(form => { %>
                    <div class="list-group-item list-group-item-action">
                        <span class="form-title"><%= form.title %></span>
                        <div class="float-right action-buttons">
                            <a href="/view-form/<%= form._id %>" class="btn btn-info btn-sm">View</a>
                            <a href="/edit-form/<%= form._id %>" class="btn btn-warning btn-sm">Edit</a>
                            <form action="/form/<%= form._id %>/export" method="POST" class="d-inline">
                                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                <button type="submit" class="btn btn-success btn-sm">Export CSV</button>
                            </form>
                            <% if (form.link) { %>
                                <button onclick="copyToClipboard('<%= form.link %>')" class="btn btn-secondary btn-sm">Share</button>
                            <% } else { %>
                                <button onclick="alert('Link not available. Please ensure the form has a valid link.')" class="btn btn-secondary btn-sm disabled">Share</button>
                            <% } %>
                            <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteConfirmModal" data-form-id="<%= form._id %>" data-form-title="<%= form.title %>" data-csrf-token="<%= csrfToken %>">Delete</button>
                        </div>
                    </div>
                <% }); %>
            </div>
        <% } else { %>
            <p>You have not created any feedback forms yet.</p>
        <% } %>
    </div>

    <!-- Single Modal Structure for Deletion Confirmation -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            Are you sure you want to delete the form "<span id="formTitleToDelete"></span>"?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <form id="deleteForm" action="" method="POST">
                <input type="hidden" name="_csrf" value="">
                <button type="submit" class="btn btn-danger">Delete</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Create Form Modal -->
    <div class="modal fade" id="createFormModal" tabindex="-1" aria-labelledby="createFormModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createFormModalLabel">Create New Form</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="createFormDraftForm">
                        <div class="mb-3">
                            <label for="formTitle" class="form-label">Form Title</label>
                            <input type="text" class="form-control" id="formTitle" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="createFormDraftBtn">Create Draft</button>
                </div>
            </div>
        </div>
    </div>

    <%- include('partials/_footer.ejs') %>
    <script type="module">
        import('/js/dashboardScripts.js').then(module => {
            // The module is loaded. Functions are now available.
            console.log('Dashboard scripts loaded dynamically.');
        }).catch(err => {
            console.error('Failed to load dashboard scripts:', err);
        });
    </script>
</body>
</html>