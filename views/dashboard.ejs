<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('partials/_head.ejs') %>
    <title>Dashboard</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/bokehButtonStyles.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"></script>
</head>
<body>
    <%- include('partials/_header.ejs') %>
    <div class="container mt-5">
        <h1>Welcome to Your Dashboard</h1>
        <p>Here you can manage your feedback forms.</p>
        <a href="/subscribe" class="btn btn-success">Subscribe</a>
        <% if (forms.length > 0) { %>
            <div class="list-group">
                <% forms.forEach(form => { %>
                    <div class="list-group-item list-group-item-action">
                        <span class="form-title"><%= form.title %></span>
                        <div class="float-right action-buttons">
                            <a href="/view-form/<%= form._id %>" class="btn btn-info btn-sm">View</a>
                            <a href="/edit-form/<%= form._id %>" class="btn btn-warning btn-sm">Edit</a>
                            <a href="/form/<%= form._id %>/export/csv" class="btn btn-success btn-sm">Export CSV</a>
                            <% if (form.link) { %>
                                <button onclick="copyToClipboard('<%= form.link %>')" class="btn btn-secondary btn-sm">Share</button>
                            <% } else { %>
                                <button onclick="alert('Link not available. Please ensure the form has a valid link.')" class="btn btn-secondary btn-sm disabled">Share</button>
                            <% } %>
                            <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteConfirmModal" data-form-id="<%= form._id %>" data-form-title="<%= form.title %>" data-csrf-token="<%= csrfToken %>">Delete</button>
                        </div>
                    </div>
                <% }); %>
            </div>
        <% } else { %>
            <p>You have not created any feedback forms yet.</p>
        <% } %>
    </div>
    <%- include('partials/_footer.ejs') %>
    <script src="/js/dashboardScripts.js"></script>
    <script>
        function copyToClipboard(text) {
            if (!navigator.clipboard) {
                // Fallback for browsers that don't support the Clipboard API
                var textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    var successful = document.execCommand('copy');
                    var msg = successful ? 'successful' : 'unsuccessful';
                    console.log('Fallback: Copying text command was ' + msg);
                    alert('Form link copied to clipboard!');
                } catch (err) {
                    console.error('Fallback: Could not copy text', err);
                }
                document.body.removeChild(textArea);
                return;
            }
            navigator.clipboard.writeText(text).then(function() {
                console.log('Form link copied to clipboard!');
                alert('Form link copied to clipboard!');
            }, function(err) {
                console.error('Could not copy text: ', err);
            });
        }
    </script>

    <!-- Single Modal Structure for Deletion Confirmation -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            Are you sure you want to delete the form "<span id="formTitleToDelete"></span>"?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <form id="deleteForm" action="" method="POST">
                <input type="hidden" name="_csrf" value="">
                <button type="submit" class="btn btn-danger">Delete</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script>
        $('#deleteConfirmModal').on('show.bs.modal', function (event) {
            var button = $(event.relatedTarget) // Button that triggered the modal
            var formId = button.data('form-id') // Extract info from data-* attributes
            var formTitle = button.data('form-title')
            var csrfToken = button.data('csrf-token')
            var modal = $(this)
            modal.find('.modal-body #formTitleToDelete').text(formTitle)
            modal.find('.modal-footer #deleteForm').attr('action', '/delete-form/' + formId)
            modal.find('.modal-footer #deleteForm input[name="_csrf"]').val(csrfToken)
        })
    </script>
</body>
</html>